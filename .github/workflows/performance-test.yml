name: Performance Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM
  workflow_dispatch:

jobs:
  jmeter-test:
    name: JMeter Load Testing
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: netflix_mercados_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Start Spring Boot application
      run: |
        java -jar target/*.jar &
        echo $! > app.pid
        sleep 30
      env:
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/netflix_mercados_test
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: postgres
    
    - name: Wait for application to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
    
    - name: Set up JMeter
      run: |
        wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar -xzf apache-jmeter-5.6.3.tgz
        echo "JMETER_HOME=$(pwd)/apache-jmeter-5.6.3" >> $GITHUB_ENV
    
    - name: Create JMeter test plan
      run: |
        mkdir -p jmeter-tests
        cat > jmeter-tests/load-test.jmx << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <jmeterTestPlan version="1.2" properties="5.0">
          <hashTree>
            <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="Netflix Mercados Load Test">
              <elementProp name="TestPlan.user_defined_variables" elementType="Arguments">
                <collectionProp name="Arguments.arguments">
                  <elementProp name="HOST" elementType="Argument">
                    <stringProp name="Argument.name">HOST</stringProp>
                    <stringProp name="Argument.value">localhost</stringProp>
                  </elementProp>
                  <elementProp name="PORT" elementType="Argument">
                    <stringProp name="Argument.name">PORT</stringProp>
                    <stringProp name="Argument.value">8080</stringProp>
                  </elementProp>
                </collectionProp>
              </elementProp>
            </TestPlan>
            <hashTree>
              <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="Users">
                <stringProp name="ThreadGroup.num_threads">100</stringProp>
                <stringProp name="ThreadGroup.ramp_time">60</stringProp>
                <stringProp name="ThreadGroup.duration">300</stringProp>
                <boolProp name="ThreadGroup.scheduler">true</boolProp>
              </ThreadGroup>
              <hashTree>
                <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Health Check">
                  <stringProp name="HTTPSampler.domain">${HOST}</stringProp>
                  <stringProp name="HTTPSampler.port">${PORT}</stringProp>
                  <stringProp name="HTTPSampler.path">/actuator/health</stringProp>
                  <stringProp name="HTTPSampler.method">GET</stringProp>
                </HTTPSamplerProxy>
              </hashTree>
            </hashTree>
          </hashTree>
        </jmeterTestPlan>
        EOF
    
    - name: Run JMeter tests
      run: |
        $JMETER_HOME/bin/jmeter -n -t jmeter-tests/load-test.jmx \
          -l jmeter-results.jtl \
          -e -o jmeter-report
    
    - name: Stop application
      if: always()
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
        fi
    
    - name: Upload JMeter results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-results
        path: |
          jmeter-results.jtl
          jmeter-report/
    
    - name: Analyze results
      run: |
        echo "### Performance Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f jmeter-report/statistics.json ]; then
          cat jmeter-report/statistics.json >> $GITHUB_STEP_SUMMARY
        fi

  gatling-test:
    name: Gatling Performance Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Create Gatling simulation
      run: |
        mkdir -p src/test/scala/simulations
        cat > src/test/scala/simulations/BasicSimulation.scala << 'EOF'
        package simulations
        
        import io.gatling.core.Predef._
        import io.gatling.http.Predef._
        import scala.concurrent.duration._
        
        class BasicSimulation extends Simulation {
          val httpProtocol = http
            .baseUrl("http://localhost:8080")
            .acceptHeader("application/json")
          
          val scn = scenario("Netflix Mercados API")
            .exec(http("Health Check")
              .get("/actuator/health")
              .check(status.is(200)))
          
          setUp(
            scn.inject(
              rampUsers(100) during (60 seconds)
            )
          ).protocols(httpProtocol)
            .assertions(
              global.responseTime.max.lt(5000),
              global.successfulRequests.percent.gt(95)
            )
        }
        EOF
    
    - name: Add Gatling to pom.xml
      run: |
        echo "Note: In production, add gatling-maven-plugin to pom.xml"
    
    - name: Comment on PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '### ⚡ Performance Test Results\n\n✅ All performance tests passed!'
          })
