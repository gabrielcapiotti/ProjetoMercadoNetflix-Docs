# Arquitetura e Diagramas - Netflix Mercados API

> VisualizaÃ§Ã£o da arquitetura, fluxos e relacionamentos do sistema

## ğŸ“ Arquitetura em Camadas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT (Web/Mobile)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                    â”‚
                 â”‚ HTTP/HTTPS + JWT Token             â”‚
                 â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRESENTATION LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MercadoController     â”‚  â”‚ AvaliacaoController          â”‚   â”‚
â”‚  â”‚ - 12 endpoints        â”‚  â”‚ - 7 endpoints                â”‚   â”‚
â”‚  â”‚ - @RequestBody/@Valid â”‚  â”‚ - @PreAuthorize              â”‚   â”‚
â”‚  â”‚ - @Operation/@ApiResp â”‚  â”‚ - @Slf4j logging             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                           â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â–¼                                     â”‚
â”‚              GlobalExceptionHandler                              â”‚
â”‚              - ResourceNotFoundException                         â”‚
â”‚              - ValidationException                              â”‚
â”‚              - UnauthorizedException                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MercadoService        â”‚  â”‚ AvaliacaoService             â”‚   â”‚
â”‚  â”‚ - CRUD logic          â”‚  â”‚ - CRUD logic                 â”‚   â”‚
â”‚  â”‚ - Business rules      â”‚  â”‚ - Rating calculations        â”‚   â”‚
â”‚  â”‚ - Validations         â”‚  â”‚ - Statistics aggregation     â”‚   â”‚
â”‚  â”‚ - Authorization       â”‚  â”‚ - Geolocation search         â”‚   â”‚
â”‚  â”‚ - @Transactional      â”‚  â”‚ - @Transactional             â”‚   â”‚
â”‚  â”‚ - @Slf4j              â”‚  â”‚ - @Slf4j                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                           â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REPOSITORY LAYER                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ MercadoRepository  â”‚  â”‚ AvaliacaoRepository          â”‚      â”‚
â”‚  â”‚ JpaRepository      â”‚  â”‚ JpaSpecificationExecutor     â”‚      â”‚
â”‚  â”‚ - Custom queries   â”‚  â”‚ - Custom queries             â”‚      â”‚
â”‚  â”‚ - Specifications   â”‚  â”‚ - Average rating calc        â”‚      â”‚
â”‚  â”‚ - Pagination       â”‚  â”‚ - Statistics queries         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                        â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ UserRepository   â”‚  â”‚ HorarioRepository     â”‚               â”‚
â”‚  â”‚ RoleRepository   â”‚  â”‚                       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERSISTENCE LAYER                            â”‚
â”‚                 (JPA/Hibernate + MySQL)                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  mercados   â”‚  â”‚  avaliacoes  â”‚  â”‚  horario_funcionam  â”‚   â”‚
â”‚  â”‚  (soft del) â”‚  â”‚  (soft del)  â”‚  â”‚  (audit)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   users     â”‚  â”‚   roles      â”‚  â”‚  user_favoritos     â”‚   â”‚
â”‚  â”‚  (soft del) â”‚  â”‚              â”‚  â”‚  (M2M join table)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Fluxo de SeguranÃ§a e AutenticaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Login/Register     â”‚
â”‚    (nÃ£o incluÃ­do)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  JWT Token   â”‚
    â”‚  Generated   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                     â”‚
           â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Bearer Tokenâ”‚      â”‚   Refresh    â”‚
    â”‚   (24h)      â”‚      â”‚   Token      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Client envia em Header: â”‚
    â”‚  Authorization: Bearer X â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ JwtAuthenticationFilter      â”‚
    â”‚ - Extrai token do Header     â”‚
    â”‚ - Valida assinatura          â”‚
    â”‚ - Verifica expiraÃ§Ã£o         â”‚
    â”‚ - Carrega usuÃ¡rio            â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€ Token VÃ¡lido â”€â”€â”
           â”‚                   â”‚
           â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SecurityContext  â”‚  â”‚ LanÃ§a exceÃ§Ã£o    â”‚
    â”‚ - Authentication â”‚  â”‚ 401 Unauthorized â”‚
    â”‚ - Principal      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ - Authorities    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ @PreAuthorize verifica:      â”‚
    â”‚ - hasRole('ADMIN')           â”‚
    â”‚ - hasRole('SELLER')          â”‚
    â”‚ - permitAll()                â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€ Autorizado â”€â”€â”
           â”‚                 â”‚
           â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Controller â”‚    â”‚ AccessDeniedException
    â”‚   executa  â”‚    â”‚ 403 Forbidden       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de CriaÃ§Ã£o de Mercado

```
Cliente
  â”‚
  â”œâ”€â”€â”€ POST /api/v1/mercados â”€â”€â”€â”€â”
  â”‚    + JWT Token              â”‚
  â”‚    + CreateMercadoRequest   â”‚
  â”‚                             â–¼
  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   â”‚ MercadoController   â”‚
  â”‚                   â”‚ @PreAuthorize       â”‚
  â”‚                   â”‚ (SELLER, ADMIN)     â”‚
  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                            â”‚
  â”‚                            â–¼
  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   â”‚ ValidationErrors?    â”‚
  â”‚                   â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
  â”‚                     â”‚                â”‚
  â”‚          NÃ£o â—„â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â–º Sim
  â”‚          â”‚                                   â”‚
  â”‚          â–¼                                   â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ MercadoService   â”‚           â”‚ 400 Bad Request      â”‚
  â”‚    â”‚ .criarMercado()  â”‚           â”‚ + validation errors  â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚             â”œâ”€ Validar CNPJ Ãºnico
  â”‚             â”œâ”€ Validar Email Ãºnico
  â”‚             â”œâ”€ Buscar usuÃ¡rio (createdBy)
  â”‚             â”œâ”€ Criar entidade Mercado
  â”‚             â”‚
  â”‚             â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ @Transactional   â”‚
  â”‚    â”‚ MercadoRepositoryâ”‚
  â”‚    â”‚ .save()          â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚             â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ Database INSERT  â”‚
  â”‚    â”‚ mercados table   â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚             â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ Mercado entity   â”‚
  â”‚    â”‚ retornado        â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚             â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ MercadoResponse  â”‚
  â”‚    â”‚ .from(mercado)   â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ ApiResponse<T>    â”‚
  â”‚    â”‚ .success()        â”‚
  â”‚    â”‚ - success: true   â”‚
  â”‚    â”‚ - data: DTO       â”‚
  â”‚    â”‚ - message: ""     â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â”‚             â–¼
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚ 201 Created      â”‚
  â”‚    â”‚ + ResponseBody   â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚             â”‚
  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€â”€â”€ JSON Response
```

---

## ğŸ“Š Fluxo de Listagem com PaginaÃ§Ã£o

```
Cliente
  â”‚
  â”œâ”€ GET /api/v1/mercados?page=0&size=20&state=SP
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MercadoController      â”‚
â”‚ .listarMercados()      â”‚
â”‚ @RequestParam          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ page = 0
         â”œâ”€ size = 20
         â”œâ”€ sortBy = "nome"
         â”œâ”€ direction = ASC
         â””â”€ estado = "SP"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Criar Pageable             â”‚
â”‚ PageRequest.of(            â”‚
â”‚   page, size,              â”‚
â”‚   Sort.by(direction,sortBy)â”‚
â”‚ )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MercadoService             â”‚
â”‚ .listarMercados(           â”‚
â”‚   pageable,                â”‚
â”‚   filtros                  â”‚
â”‚ )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MercadoRepository          â”‚
â”‚ .findAll(Specification,    â”‚
â”‚   pageable                 â”‚
â”‚ )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Aplicar filtros:
         â”‚  - deleted = false
         â”‚  - estado = "SP"
         â”‚
         â”œâ”€ Ordenar por: nome ASC
         â”‚
         â”œâ”€ PaginaÃ§Ã£o:
         â”‚  - LIMIT 20 OFFSET 0
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT query               â”‚
â”‚ FROM mercados              â”‚
â”‚ WHERE estado = 'SP'        â”‚
â”‚   AND deleted = false      â”‚
â”‚ ORDER BY nome ASC          â”‚
â”‚ LIMIT 20 OFFSET 0          â”‚
â”‚                            â”‚
â”‚ Return: Page<Mercado>      â”‚
â”‚ - content (20 items)       â”‚
â”‚ - totalElements: 145       â”‚
â”‚ - totalPages: 8            â”‚
â”‚ - current page: 0          â”‚
â”‚ - hasNext: true            â”‚
â”‚ - hasPrevious: false       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Map para DTO               â”‚
â”‚ mercados.map(              â”‚
â”‚   MercadoResponse::from    â”‚
â”‚ )                          â”‚
â”‚                            â”‚
â”‚ Return: Page<MercadoResp>  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PageResponse.fromPage()    â”‚
â”‚ {                          â”‚
â”‚   content: [...],          â”‚
â”‚   pageNumber: 0,           â”‚
â”‚   pageSize: 20,            â”‚
â”‚   totalElements: 145,      â”‚
â”‚   totalPages: 8,           â”‚
â”‚   hasNext: true,           â”‚
â”‚   hasPrevious: false       â”‚
â”‚ }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ApiResponse<PageResponse>  â”‚
â”‚ {                          â”‚
â”‚   success: true,           â”‚
â”‚   message: "...",          â”‚
â”‚   data: PageResponse,      â”‚
â”‚   timestamp: now           â”‚
â”‚ }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 200 OK                     â”‚
â”‚ + JSON Body                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
       Cliente
```

---

## ğŸ¯ Fluxo de CriaÃ§Ã£o de AvaliaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  POST /api/v1/avaliacoes                     â”‚
â”‚                  Authorization: Bearer JWT                   â”‚
â”‚              CreateAvaliacaoRequest Body                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ AvaliacaoController         â”‚
        â”‚ @PreAuthorize(hasRole(USER))â”‚
        â”‚ criarAvaliacao()            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Extract username        â”‚
        â”‚ from Authentication     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ AvaliacaoService         â”‚
        â”‚ .criarAvaliacao()        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚
        â–¼         â–¼         â–¼
    Validar  Validar   Validar
    Mercado  UsuÃ¡rio   Unicidade
    existe   existe    (1 avaliaÃ§Ã£o
             user/merc)
        â”‚         â”‚         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ValidaÃ§Ãµes OK?        â”‚
        â”‚ Sim â”€â”€â”               â”‚
        â”‚       â”‚ NÃ£o â”€â”€â”       â”‚
        â”‚       â”‚       â”‚       â”‚
        â”‚       â”‚       â–¼       â”‚
        â”‚       â”‚   ExceÃ§Ã£o     â”‚
        â”‚       â”‚   400/409     â”‚
        â”‚       â”‚       â”‚       â”‚
        â”‚       â”‚       â””â”€â”€â”€â”   â”‚
        â”‚       â”‚           â”‚   â”‚
        â”‚       â–¼           â”‚   â”‚
        â”‚  Criar Entidade   â”‚   â”‚
        â”‚  Avaliacao()      â”‚   â”‚
        â”‚  - mercado        â”‚   â”‚
        â”‚  - usuario        â”‚   â”‚
        â”‚  - nota           â”‚   â”‚
        â”‚  - comentario     â”‚   â”‚
        â”‚  - avaliacoes     â”‚   â”‚
        â”‚  - recomenda      â”‚   â”‚
        â”‚       â”‚           â”‚   â”‚
        â”‚       â–¼           â”‚   â”‚
        â”‚  @Transactional   â”‚   â”‚
        â”‚  AvaliacaoRepos   â”‚   â”‚
        â”‚  .save()          â”‚   â”‚
        â”‚       â”‚           â”‚   â”‚
        â”‚       â–¼           â”‚   â”‚
        â”‚  UPDATE mercados  â”‚   â”‚
        â”‚  SET              â”‚   â”‚
        â”‚    ratingMedio    â”‚   â”‚
        â”‚    totalAvaliacoesâ”‚   â”‚
        â”‚       â”‚           â”‚   â”‚
        â”‚       â–¼           â”‚   â”‚
        â”‚  AvaliacaoResponseâ”‚   â”‚
        â”‚  .from()          â”‚   â”‚
        â”‚       â”‚           â”‚   â”‚
        â”‚       â–¼           â”‚   â”‚
        â”‚  201 Created â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚  + JSON           â”‚   â”‚
        â”‚                   â”‚   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Modelo de Dados Relacional

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            users                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                              â”‚
â”‚ username (UNIQUE, NOT NULL)          â”‚
â”‚ email (UNIQUE, NOT NULL)             â”‚
â”‚ senha (NOT NULL)                     â”‚
â”‚ nome (NOT NULL)                      â”‚
â”‚ foto                                 â”‚
â”‚ ativo (DEFAULT: true)                â”‚
â”‚ created_at (NOT NULL)                â”‚
â”‚ updated_at (NOT NULL)                â”‚
â”‚ created_by (NOT NULL)                â”‚
â”‚ updated_by                           â”‚
â”‚ deleted (DEFAULT: false)             â”‚
â”‚ version (NOT NULL)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
    â”‚        â–¼        â–¼
    â”‚   1:N      N:M (join)
    â”‚   â”‚        â”‚
    â–¼   â”‚        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          mercados                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                              â”‚
â”‚ usuario_id (FK â†’ users.id)           â”‚
â”‚ nome (UNIQUE, NOT NULL)              â”‚
â”‚ descricao (NOT NULL)                 â”‚
â”‚ telefone (NOT NULL)                  â”‚
â”‚ email (UNIQUE, NOT NULL)             â”‚
â”‚ cnpj (UNIQUE, NOT NULL)              â”‚
â”‚ rua (NOT NULL)                       â”‚
â”‚ numero (NOT NULL)                    â”‚
â”‚ complemento                          â”‚
â”‚ cep (NOT NULL)                       â”‚
â”‚ cidade (NOT NULL)                    â”‚
â”‚ estado (NOT NULL)                    â”‚
â”‚ latitude (NOT NULL)                  â”‚
â”‚ longitude (NOT NULL)                 â”‚
â”‚ tipo_mercado (NOT NULL)              â”‚
â”‚ logo                                 â”‚
â”‚ site_url                             â”‚
â”‚ aprovado (DEFAULT: false)            â”‚
â”‚ motivo_rejeicao                      â”‚
â”‚ rating_medio (DEFAULT: 0.0)          â”‚
â”‚ total_avaliacoes (DEFAULT: 0)        â”‚
â”‚ total_favoritos (DEFAULT: 0)         â”‚
â”‚ created_at (NOT NULL)                â”‚
â”‚ updated_at (NOT NULL)                â”‚
â”‚ created_by (NOT NULL)                â”‚
â”‚ updated_by                           â”‚
â”‚ deleted (DEFAULT: false)             â”‚
â”‚ version (NOT NULL)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
         â”‚    1:N       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚                    â”‚
         â”‚    â–¼                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚                         â”‚   â”‚
    â–¼                         â–¼   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  avaliacoes          â”‚  â”‚ horario_funcionam    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)              â”‚  â”‚ id (PK)              â”‚
â”‚ mercado_id (FK)      â”‚  â”‚ mercado_id (FK)      â”‚
â”‚ usuario_id (FK)      â”‚  â”‚ dia_semana (NOT NULL)â”‚
â”‚ nota (1-5)           â”‚  â”‚ horario_abertura     â”‚
â”‚ comentario           â”‚  â”‚ horario_fechamento   â”‚
â”‚ avaliacao_atendim    â”‚  â”‚ aberto (NOT NULL)    â”‚
â”‚ avaliacao_limpeza    â”‚  â”‚ observacoes          â”‚
â”‚ avaliacao_produtos   â”‚  â”‚ created_at           â”‚
â”‚ avaliacao_precos     â”‚  â”‚ updated_at           â”‚
â”‚ recomenda            â”‚  â”‚ created_by           â”‚
â”‚ total_likes          â”‚  â”‚ updated_by           â”‚
â”‚ total_dislikes       â”‚  â”‚ deleted (DEFAULT: F) â”‚
â”‚ fotos_url            â”‚  â”‚ version              â”‚
â”‚ created_at           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ updated_at           â”‚
â”‚ created_by           â”‚
â”‚ updated_by           â”‚
â”‚ deleted              â”‚
â”‚ version              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–³
         â”‚ N:M (join)
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ user_favoritos    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ usuario_id (FK)   â”‚
    â”‚ mercado_id (FK)   â”‚
    â”‚ PK (usuario_id +  â”‚
    â”‚     mercado_id)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ Fluxo de Busca de Mercados PrÃ³ximos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/v1/mercados/nearby                 â”‚
â”‚ ?latitude=-23.550520                        â”‚
â”‚ &longitude=-46.633309                       â”‚
â”‚ &raioKm=5.0                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MercadoController  â”‚
    â”‚ .buscarProximos()  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MercadoService             â”‚
    â”‚ .buscarProximos()          â”‚
    â”‚                            â”‚
    â”‚ 1. Converter raio em graus â”‚
    â”‚    raioGraus = 5 / 111.0   â”‚
    â”‚    = 0.045 graus           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MercadoRepository          â”‚
    â”‚ .findAll(Specification)    â”‚
    â”‚                            â”‚
    â”‚ Query:                     â”‚
    â”‚ SELECT * FROM mercados     â”‚
    â”‚ WHERE                      â”‚
    â”‚  latitude BETWEEN          â”‚
    â”‚   (-23.550520 - 0.045)     â”‚
    â”‚   AND                      â”‚
    â”‚   (-23.550520 + 0.045)     â”‚
    â”‚  AND                       â”‚
    â”‚  longitude BETWEEN         â”‚
    â”‚   (-46.633309 - 0.045)     â”‚
    â”‚   AND                      â”‚
    â”‚   (-46.633309 + 0.045)     â”‚
    â”‚  AND aprovado = true       â”‚
    â”‚  AND deleted = false       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ List<Mercado> candidatos   â”‚
    â”‚ (Retangular rough filter)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Para cada candidato:       â”‚
    â”‚ Calcular distÃ¢ncia Real    â”‚
    â”‚                            â”‚
    â”‚ Haversine Formula:         â”‚
    â”‚ a = sinÂ²(Î”Ï†/2)             â”‚
    â”‚   + cos(Ï†1)*cos(Ï†2)*      â”‚
    â”‚   sinÂ²(Î”Î»/2)               â”‚
    â”‚                            â”‚
    â”‚ c = 2*atan2(âˆša, âˆš(1-a))    â”‚
    â”‚ d = R*c (R = 6371km)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Filtrar apenas <= 5km      â”‚
    â”‚                            â”‚
    â”‚ Stream filter             â”‚
    â”‚ .filter(d <= raioKm)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Converter para DTO         â”‚
    â”‚ List<MercadoResponse>      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 200 OK                     â”‚
    â”‚ + List JSON                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    Cliente recebe mercados 
    dentro de 5km do ponto
```

---

## ğŸ“ˆ Fluxo de CÃ¡lculo de EstatÃ­sticas

```
GET /api/v1/mercados/{id}/stats
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AvaliacaoController            â”‚
â”‚ .obterEstatisticasAvaliacao()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AvaliacaoService     â”‚
    â”‚ .obter              â”‚
    â”‚ EstatisticasAvaliacaoâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â–¼                   â–¼
    Contar         Query AVG
    avaliacoes     de notas
    por nota
        â”‚                   â”‚
        â”œâ”€ 5 estrelas: 6    â”‚
        â”œâ”€ 4 estrelas: 3    â”‚  Resultado:
        â”œâ”€ 3 estrelas: 1    â”‚  4.5
        â”œâ”€ 2 estrelas: 0    â”‚
        â””â”€ 1 estrela:  0    â”‚
        â”‚                   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RatingStatsResponse {   â”‚
    â”‚  mercadoId: 1,          â”‚
    â”‚  mercadoNome: "...",    â”‚
    â”‚  ratingMedio: 4.5,      â”‚
    â”‚  totalAvaliacoes: 10,   â”‚
    â”‚  avaliacoes5E: 6,       â”‚
    â”‚  avaliacoes4E: 3,       â”‚
    â”‚  avaliacoes3E: 1,       â”‚
    â”‚  avaliacoes2E: 0,       â”‚
    â”‚  avaliacoes1E: 0        â”‚
    â”‚ }                       â”‚
    â”‚                         â”‚
    â”‚ Calcular Percentual:    â”‚
    â”‚ (6+3)/10 * 100 = 90%    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        200 OK + JSON
```

---

## ğŸ” Matriz de PermissÃµes

| Endpoint | GET | POST | PUT | DELETE |
|----------|-----|------|-----|--------|
| `/mercados` | âœ… PÃºblico | âœ… SELLER/ADMIN | - | - |
| `/mercados/{id}` | âœ… PÃºblico | - | âœ… SELLER/ADMIN | âœ… SELLER/ADMIN |
| `/mercados/{id}/approve` | - | âœ… ADMIN | - | - |
| `/mercados/{id}/reject` | - | âœ… ADMIN | - | - |
| `/mercados/nearby` | âœ… PÃºblico | - | - | - |
| `/mercados/{id}/favorite` | - | âœ… USER | - | âœ… USER |
| `/mercados/{id}/hours` | âœ… PÃºblico | âœ… SELLER/ADMIN | - | - |
| `/avaliacoes` | âœ… PÃºblico | âœ… USER | - | - |
| `/avaliacoes/{id}` | âœ… PÃºblico | - | âœ… USER | âœ… USER |
| `/mercados/{id}/avaliacoes` | âœ… PÃºblico | - | - | - |
| `/mercados/{id}/stats` | âœ… PÃºblico | - | - | - |

---

## ğŸ“Š EstatÃ­sticas de ImplementaÃ§Ã£o

| Aspecto | Quantidade |
|---------|-----------|
| **Controllers** | 2 |
| **Services** | 2 |
| **Repositories** | 5 |
| **DTOs** | 15+ |
| **Endpoints** | 19 |
| **HTTP Methods** | 5 (GET, POST, PUT, DELETE, OPTIONS) |
| **HTTP Status Codes** | 8 |
| **Regras de NegÃ³cio** | 25+ |
| **ValidaÃ§Ãµes** | 50+ |
| **Linhas de CÃ³digo** | 3.500+ |
| **DocumentaÃ§Ã£o Swagger** | Completa (100%) |

---

## ğŸš€ Performance e OtimizaÃ§Ãµes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PERFORMANCE STRATEGIES         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… PaginaÃ§Ã£o (limite de resultados) â”‚
â”‚ âœ… Lazy Loading (Entity relationshipsâ”‚
â”‚ âœ… Indexes no banco (id, cnpj, etc) â”‚
â”‚ âœ… Query optimization (SELECT *)    â”‚
â”‚ âœ… Caching (HTTP headers)           â”‚
â”‚ âœ… Connection Pooling (HikariCP)    â”‚
â”‚ âœ… TransaÃ§Ãµes (readOnly: true)      â”‚
â”‚ âœ… Soft Delete (sem hard delete)    â”‚
â”‚ âœ… Specification pattern (queries)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ciclo de Vida de uma Request

```
Request HTTP
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CORS Validation     â”‚ â† Verifica origem
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JwtAuthFilter       â”‚ â† Extrai/valida token
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SecurityFilter      â”‚ â† Seta contexto seguranÃ§a
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DispatcherServlet   â”‚ â† Routing
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller          â”‚ â† Endpoint handler
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @Valid validates    â”‚ â† DTO validation
â”‚ Request args        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service             â”‚ â† Business logic
â”‚ @Transactional      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Repository (JPA)    â”‚ â† Database access
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hibernate           â”‚ â† ORM layer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQL Database      â”‚ â† Execute SQL
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Exception Handler?  â”‚ â† Error handling
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
  â”‚        â”‚        â”‚
  No      Yes      CORS
  â”‚        â”‚        â”‚
  â–¼        â–¼        â–¼
Response  Error    Error
  201/200  400/404  403
  â”‚        â”‚        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    HTTP Response +
    JSON Body +
    Headers
           â”‚
           â–¼
        Cliente
```

---

**VersÃ£o:** 1.0.0  
**Ãšltima atualizaÃ§Ã£o:** 30 de janeiro de 2026  
**Status:** Pronto para implementaÃ§Ã£o âœ…
